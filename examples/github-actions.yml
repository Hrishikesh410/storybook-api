# Example GitHub Actions workflow for Storybook Metadata Extraction

name: Build Storybook with Metadata

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-storybook:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Storybook with Metadata
        run: npm run build-storybook
        # This automatically runs metadata:generate after build
      
      - name: Verify metadata was generated
        run: |
          if [ -f "storybook-static/stories.json" ]; then
            echo "âœ… Metadata file generated successfully"
            echo "ðŸ“Š Story count:"
            cat storybook-static/stories.json | jq '.totalStories'
          else
            echo "âŒ Metadata file not found"
            exit 1
          fi
      
      - name: Upload Storybook
        uses: actions/upload-artifact@v3
        with:
          name: storybook-build
          path: storybook-static/
          retention-days: 30
      
      - name: Upload Metadata
        uses: actions/upload-artifact@v3
        with:
          name: storybook-metadata
          path: storybook-static/stories.json
          retention-days: 90
      
      - name: Comment PR with Stats
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metadata = JSON.parse(
              fs.readFileSync('storybook-static/stories.json', 'utf-8')
            );
            
            const comment = `## ðŸ“š Storybook Build Complete
            
            **Total Stories:** ${metadata.totalStories}
            **Generated:** ${metadata.generatedAt}
            **Extraction Method:** ${metadata.extractedFrom}
            
            [View Storybook Build](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Optional: Deploy to GitHub Pages
  deploy-storybook:
    needs: build-storybook
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: storybook-build
          path: ./storybook-static
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./storybook-static
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Optional: Advanced metadata processing
  process-metadata:
    needs: build-storybook
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download metadata
        uses: actions/download-artifact@v3
        with:
          name: storybook-metadata
          path: ./
      
      - name: Process metadata
        run: |
          # Extract component list
          cat stories.json | jq -r '.stories | 
            to_entries | 
            map(.value.title) | 
            unique | 
            .[]' > components.txt
          
          echo "ðŸ“¦ Components found:"
          cat components.txt
      
      - name: Generate documentation
        run: |
          # Example: Generate markdown from metadata
          node -e "
          const fs = require('fs');
          const metadata = JSON.parse(fs.readFileSync('stories.json', 'utf-8'));
          
          let md = '# Component Documentation\n\n';
          md += \`Total Components: \${metadata.totalStories}\n\n\`;
          
          Object.values(metadata.stories).forEach(story => {
            md += \`## \${story.title} - \${story.name}\n\`;
            md += \`\${story.docs.description}\n\n\`;
          });
          
          fs.writeFileSync('COMPONENTS.md', md);
          "
      
      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: component-docs
          path: COMPONENTS.md

